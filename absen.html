<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi - PKL Project</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .navbar { background-color: #f8f8f8; border-bottom: 1px solid #ddd; }
    .navbar-brand { font-weight: bold; color: #444; }
    footer { text-align: center; padding: 10px; font-size: 14px; color: #666; border-top: 1px solid #ddd; background: #f8f8f8; margin-top: 50px; }
    .container-absen { max-width: 800px; margin: 40px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .user-info { text-align: center; font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1e3a8a; }
    .btn-small { width: 120px; font-size: 14px; padding: 6px 10px; border-radius: 6px; }
    .btn-masuk { background-color: #2563eb; color: white; }
    .btn-pulang { background-color: #16a34a; color: white; }
    .btn-riwayat { background-color: #64748b; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    table { width: 100%; margin-top: 20px; }
    th, td { text-align: center; padding: 8px; }
  </style>
</head>
<body>

  <!-- ===== NAVBAR ===== -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      <a class="navbar-brand" href="index.html">PKL Project</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">ğŸ  Beranda</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">ğŸ“ Input Kegiatan</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="rencana.html">ğŸ—’ï¸ Rencana Kegiatan</a></li>
              <li><a class="dropdown-item active" href="absen.html">ğŸ“… Absensi</a></li>
              <li><a class="dropdown-item" href="index.html">âœï¸ Log Kegiatan</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="penilaian.html">ğŸ“Š Penilaian</a></li>
          <li class="nav-item"><a class="nav-link" href="pengumuman.html">ğŸ“¢ Pengumuman</a></li>
          <!-- MENU ADMIN: DATA PKL -->
          <li class="nav-item admin-only" style="display:none;">
            <a class="nav-link" href="data-pkl.html">ğŸ“‹ Data PKL</a>
          </li>
        </ul>

        <ul class="navbar-nav">
          <li class="nav-item"><a id="userNavbarName" class="nav-link" href="#">ğŸ‘¤ Siswa</a></li>
          <li class="nav-item"><a id="logoutBtn" class="nav-link" href="#">ğŸšª Keluar</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ===== BREADCRUMB ===== -->
  <div class="container mt-3">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Absensi</li>
      </ol>
    </nav>
  </div>

  <!-- ===== ABSENSI ===== -->
  <div class="container-absen">
    <div class="user-info" id="userName">Nama: -</div>
    <div class="text-center mb-2" id="currentTime" style="color:#6b7280; font-size:14px;"></div>

    <!-- USER MODE -->
    <div id="userAbsenSection">
      <div class="d-flex justify-content-center gap-3 mb-3">
        <button id="absenBtn" class="btn btn-small btn-masuk">Masuk</button>
        <button id="pulangBtn" class="btn btn-small btn-pulang">Pulang</button>
      </div>
      <div class="text-center mb-3">
        <button id="riwayatBtn" class="btn btn-small btn-riwayat">Riwayat Absen</button>
      </div>
      <table class="table table-bordered d-none" id="absenTable">
        <thead class="table-light">
          <tr><th>Tanggal</th><th>Masuk</th><th>Pulang</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ADMIN MODE -->
    <div id="adminAbsenSection" style="display:none;">
      <h5 class="text-center text-primary mb-3">ğŸ“‹ Data Absensi Semua Siswa</h5>
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Nama</th>
            <th>Email</th>
            <th>PKL</th>
            <th>Tanggal</th>
            <th>Masuk</th>
            <th>Pulang</th>
          </tr>
        </thead>
        <tbody id="adminAbsenTable"></tbody>
      </table>
    </div>
  </div>

  <footer>Copyright Â© 2025 | PKL Project</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const currentEmail = localStorage.getItem("currentUserEmail");
    const users = JSON.parse(localStorage.getItem("users")) || {};
    const userData = currentEmail ? users[currentEmail] : null;
    const isAdmin = localStorage.getItem("isAdmin") === "true";

    if (!currentEmail) window.location.replace("login.html");

    const userNavbar = document.getElementById("userNavbarName");
    const userNameEl = document.getElementById("userName");

    // ===== ADMIN MENU NAVBAR =====
    if (isAdmin) {
      userNavbar.textContent = "ğŸ‘‘ Admin";
      userNameEl.textContent = "ğŸ‘‘ Admin Panel";
      document.getElementById("userAbsenSection").style.display = "none";
      document.getElementById("adminAbsenSection").style.display = "block";
      document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
    } else {
      userNavbar.textContent = "ğŸ‘¤ " + (userData?.nama || "Siswa");
      userNameEl.textContent = "Nama: " + (userData?.nama || "-");
    }

    // ===== LOGOUT =====
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUserEmail");
      localStorage.removeItem("isAdmin");
      window.location.replace("login.html");
    });

    // ===== JAM REALTIME =====
    function updateClock() {
      const now = new Date();
      document.getElementById("currentTime").textContent =
        now.toLocaleString("id-ID", { dateStyle: "full", timeStyle: "medium" });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ===== MODE USER =====
    if (!isAdmin) {
      const key = `absensiData_${currentEmail}`;
      let dataAbsen = JSON.parse(localStorage.getItem(key)) || [];
      const absenTable = document.querySelector("#absenTable tbody");
      const absenBtn = document.getElementById("absenBtn");
      const pulangBtn = document.getElementById("pulangBtn");
      const riwayatBtn = document.getElementById("riwayatBtn");
      const tableContainer = document.getElementById("absenTable");

      function renderTabel() {
        absenTable.innerHTML = "";
        dataAbsen.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.tanggal}</td><td>${row.masuk || '-'}</td><td>${row.pulang || '-'}</td>`;
          absenTable.appendChild(tr);
        });
      }

      const todayDate = new Date().toLocaleDateString("id-ID");
      const today = dataAbsen.find(a => a.tanggal === todayDate);
      if (today) {
        if (today.masuk) absenBtn.disabled = true;
        if (today.pulang) pulangBtn.disabled = true;
      }

      absenBtn.addEventListener("click", () => {
        const now = new Date();
        const tanggal = now.toLocaleDateString("id-ID");
        const waktu = now.toLocaleTimeString("id-ID");
        let today = dataAbsen.find(a => a.tanggal === tanggal);
        if (today && today.masuk) return alert("Anda sudah absen masuk hari ini!");
        if (!today) dataAbsen.push({ tanggal, masuk: waktu, pulang: "" });
        localStorage.setItem(key, JSON.stringify(dataAbsen));
        alert("Absen masuk berhasil!");
        absenBtn.disabled = true;
        renderTabel();
      });

      pulangBtn.addEventListener("click", () => {
        const now = new Date();
        const tanggal = now.toLocaleDateString("id-ID");
        const waktu = now.toLocaleTimeString("id-ID");
        let today = dataAbsen.find(a => a.tanggal === tanggal);
        if (!today || !today.masuk) return alert("Anda belum absen masuk!");
        if (today.pulang) return alert("Anda sudah absen pulang!");
        today.pulang = waktu;
        localStorage.setItem(key, JSON.stringify(dataAbsen));
        alert("Absen pulang berhasil!");
        pulangBtn.disabled = true;
        renderTabel();
      });

      riwayatBtn.addEventListener("click", () => {
        tableContainer.classList.toggle("d-none");
        if (!tableContainer.classList.contains("d-none")) renderTabel();
      });
    }

    // ===== MODE ADMIN =====
    if (isAdmin) {
      const adminTable = document.getElementById("adminAbsenTable");
      adminTable.innerHTML = "";
      let adaData = false;
      Object.keys(users).forEach(email => {
        const user = users[email];
        if (!user || !user.nama) return;

        let absensi = JSON.parse(localStorage.getItem(`absensiData_${email}`));
        if (!Array.isArray(absensi)) {
          if (absensi && typeof absensi === "object") absensi = [absensi];
          else absensi = [];
        }

        absensi.forEach(a => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${user.nama}</td>
            <td>${email}</td>
            <td>${user.pkl || '-'}</td>
            <td>${a.tanggal || '-'}</td>
            <td>${a.masuk || '-'}</td>
            <td>${a.pulang || '-'}</td>
          `;
          adminTable.appendChild(tr);
          adaData = true;
        });
      });

      if (!adaData) {
        adminTable.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Belum ada data absensi dari siswa.</td></tr>`;
      }
    }
  </script>
</body>
</html>
